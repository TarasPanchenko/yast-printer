<html><head><title>CUPS and SuSE Printer database</title></head><body>
<h2>CUPS and SuSE Printer database</h2>
<p>
Goal: use effectively new SuSE printer database for printer configuration in
CUPS system.
</p>

<a href="#summary">See summary</a><br>

<h3>What do we need for CUPS?</h3>
<p>
The only we need is a PPD file based on the data based on printer database
selected by user. Printer database is does not contain PPD files, therefore
they need to be generated. There is a problem. PPD files do not support
hierarchical options very well. Theoreticaly there is some support via
conflicts but these conflicts are loosely supported by applications. So we
have to generate non-hierarchical lists of options (PPD files) from our highly
hierarchical options trees in the database. Most probably the best way will be
using the selected leaf-options for the PPD file generation. On the other hand
we want to present user the hierarchy of options, so we will use the printer
database to display options. Which bring us to the problem. New cups
configuration tool will work with printer database. Old cups configuration
tool works with ppd files. Will the new configuration tool support editation
of options of the printer created by the old conf. tool? And will it support
creation of printers by supplying a ppd file?
</p>
<h3>Foreign PPD files</h3>
<p>
If we support full editation of options contained in ppd files, we have to
have 2 configuration tools in one -- one for printer database and the other
for cups ppd files. The other extreme case is completely abandoned ppd file
support. We can choose something in between instead. I think the ideal
solution is to support only the full editation of printers based on printer
database and support only ppd file selection for foreigh ppd files. Summary of
features:<ul>
<li>Printers can be autodetected and fully configured with utilization of
SuSE printer database or vendor supplied printer database.</li>
<li>Queues created with the use of printer database will be editable by
cups tools (e.g. web interface) but configuration options won't be as rich
as in YaST2. <font color="red">It may mean that we allow no changes in cups 
interface (the ppd file will have no gui options)</font></li>
<li>Other PPD file can be selected for a queue, but options for such queue
shall not be edited by YaST2.</li>
<li>We may implement a functions to save ppd files from the printer database
so that such files will be usable with external tools. <font color="red">But
see the red note above.</font></li>
</ul>
</p>
<h3>Printconf</h3>
<p>
As the printer database will be the same for lprng and cups configuration
tools, we will be able to merge both tools in one. The differences between
them are:<ul>
<li><b>Reading:</b> in lpd we reed <tt>printcap</tt> and
<tt>/etc/lpdfilter/*</tt>, in cups will will be reading our saved files
from <tt>/var/lib/YaST2/somewhere</tt> and <tt>.cups.printer</tt> and
<tt>.cups.classes</tt>.</li>
<li><b>Writing:</b> in lpd we have to save a lot of different files, in cups
we will be sawing only out yast2-specific file with printer settings and
<tt>.cups.(printer|class)</tt>.</li>
<li><b>Model selection:</b> in cups there will be ppd files selection.</li>
<li><b>Ascii features settings:</b> they are different for lpd and cups.</li>
<li><b>Cups detailed settings:</b> there are just a few dialogs that are cups
specific and can't be used in lpd config.</li>
</ul>
</p>
<h2>CUPS spooler</h2>
<h3>More queues for one printer</h3>
<p>
In cups it is impossible to have more queues for one printer. The backends try
to print simultaneously and the result isn't correct. (<font
color="red">FIXME: do we have the same problem in lpd?</font>) But suse
printing system is based on the idea of more queues for one printer. So we
have to make out a work-around. I have 2 ideas.<br>
<h4>(1) Use forwarding queue</h4><br>
<img src="cups-multi1.png"><br><br>
And problems with sending more jobs at one device at once are away, but there
is an extra overhead in having a transport queue. It may have drastic effects
on a disc space because the jobs will be stored in the transport queue in
filtered form (in printer-specific language). On the other hand, this lay-out
is cups-friendly and can be used without yast2. Another problem is managing
the jobs. I this layout removing job or re-ordering jobs in queue would be
hard. 
<h4>(2) Use options to define type</h4><br>
<img src="cups-multi2.png"><br><br>
This is much simplier scheme. The basic idea of one queue (logical device) for
one printer (physical device) is completly new in SuSE print system but makes
sense and perhaps makes it easier to understand by unexperienced user. But
requires "extra actions". The queue must be able to handle the options to
switch between configurations, hence it would be restricted only to queues
defined by yast2. This approach has no support in current GUI applications. In
KDE printing user can choose a queue to print to, and I believe they can
choose a command line, which is what we need. But choosing a queue from combo
box is more comfortable then editing a command line.<br>
<b>Hot news for me:</b> CUPS supports this mechanism in so called
<b>instance</b>s, that are sets of predefined options. We can create for
example instance <tt>photo</tt> of printer <tt>printer1</tt>. It will be
accessed via <tt>printer1/photo</tt>. KDE supports the instances so it is all
we wanted I suppose.
</p>

<h2><a name="summary">Summary</h2>
<p>
Goals: <ul>
<li>Use suse printer database.</li>
<li>Have one queue per one printer.</li>
<li>Give user the possibility to choose style of printing via kde print
dialog</li>
</ul>
Solution: <br>
We need one queue with the ability to filter input to different types of
output -- color/mono/photo/... therefore our ppd file has to have all these
abilities in one. So we have to generate such ppd file. The easiest solution
is having upp files for different queue types stored elsewhere and put only
a possibility to select a queue-type into ppd file. The related part of ppd 
file will look like this:<pre>
*OpenUI *Type/Printer type: PickOne
*DefaultResolution: ps
*Type ps/Postscript: "%% Only a comment"
*Type ps1/PS1: "%% Only a comment"
*Type pdf/Portable Document Format: "%% Only a comment"
*CloseUI: *Resolution
</pre>
and filter must be able to follow mapping between {$printer,$type} and 
saved upp file. Note that we must include Page Sizes into the ppd file 
besides, because without this the queue doesn't work. Most probably it
is used by other filters. We also shouldn't forget to strip the paper
size commands off the upp file.
</p>
<p>
So we have a queue, lets say <tt>lp</tt> and three types in ppd file: <tt>
ps, ps1, pdf</tt>. But user still can choose only one destination - 
<tt>lp</tt>. Lets start with instances. Instances are basicly sets of 
options saved under a name. We can define them by running<br>
<tt>lpoptions -plp/pdf -otype=pdf</tt><br>
<tt>lpoptions -plp/ps  -otype=ps</tt><br>
<tt>lpoptions -plp/ps1 -otype=ps1</tt><br>
Printing is done by <tt>lpr -Plp/pfg file</tt><br>
According to rumors I heard instances are offered by KDE print dialog as 
destinations.
</p>
<p>
<b>TODO:</b><ul>
<li>There is a possibility to reuse lpdfilter settings in cups. Do we want to
try it? We do not need lpdfilter for cups.</li>
</ul>
</p>
</body></html>
