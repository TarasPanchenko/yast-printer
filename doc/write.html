<HTML>
<HEAD>
   <TITLE>Printconf Write Module</TITLE>
   <STYLE type="text/css">
   BODY { 
     color: black;
     background: white
   }
   </STYLE>
</HEAD>
<BODY>
<TABLE BORDER WIDTH="100%">
  <TR>
    <TD>Document</TD>
    <TD>Printconf Write Module</TD>
  </TR>
  <TR>
    <TD>Author</TD>
    <TD>Jan Holesovsky, &lt;kendy@suse.cz&gt;, Petr Blahos &lt;pblahos@suse.cz&gt;</TD>
  </TR>
  <TR>
    <TD>Id</TD>
    <TD>$Id$</TD>
  </TR>
</TABLE>
<H3>Overview</H3>
<P>princonf_write.ycp can work in two modes. If there is second argument it
means that <TT>test page</TT> is about to be printed. If there is only one
argument -- <TT>user_settings</TT>, it is going on final save.
</P>
<H3>Input</H3>
<P>
printconf_write.ycp takes following arguments:
<ol>
<li><TT>map</TT> user_settings -- described in
<a href="user_settings.txt">user_settings.txt</a></li>
<li><TT>integer</TT> index of queue to print test page to, optional</li>
<li><TT>string</TT> <TT>"ps"|"ascii"</TT> type of test page, optional</li>
</ol>
</P>
<H3>Process of saving</H3>
<P>
<ul>
<li>back up files <TT>/etc/printcap /etc/gs.upp/* /etc/apsfilterrc*</TT></li>
<li>remove <TT>/etc/printcap</TT> (it will be re-created by apsfilter</li>
<li>for each configured printer: if printer was already configured
  <ul>
  <li>create file <TT>/etc/gs.upp/y2prn_&lt;printer name&gt;.upp</TT> (filter
  settings may be here)</li>
  <li>add saved printcap entry for this printer to <TT>/etc/printcap</TT></li>
  </ul>
</li>
<li>for each configured printer: if printer is new remote printer
  <ul>
  <li>create new apsfilter via <TT>/var/lib/apsfilter/apsfilter.setup -A -h
  &lt;hostname&gt; -R &lt;remote queue&gt; -N &lt;queue name&gt;</TT> This also
  creates default <TT>/etc/apsfilterrc.&lt;upp name&gt;</TT> file</li>
  </ul>
</li>
<li>for each configured printer: if printer is new and is not remote printer
  <ul>
  <li>create new upp file</li>
  <li>create new apsfilter via <TT>/var/lib/apsfilter/apsfilter.setup -A
  &lt;baud rate&gt; -d &lt;device&gt; -upp &lt;y2prn_queue name.upp&gt; -N &lt;queue name&gt; </TT></li>
  </ul>
</li>
<li>for each printer <TT>printcap</TT> entry for the printer is saved to
<TT>/etc/gs.upp/y2prn_&lt;queue name&gt;.yast2</TT></li>
<li>for each printer that is configured by yast2 or at least apsfilter, change
apsfilterrc:
  <ul>
  <li>for Epson USB printers, add init string to <TT>RESET_BEFORE</TT> (see <a
  href="http://sdb.suse.de/en/sdb/html/jsmeix_print-stcXXXusb.html">Epson USB
  printers</a>)</li>
  <li>save options to apsfilterrc</li>
  <li>for Samba and NCP write <TT>REMOTE_PRINTER</TT> entry to apsfilterrc</li>
  </ul>
</ul>

Settings are saved now. For testpage printing:
<ul>
<li>restart lpd, because it must re-read <TT>/etc/printcap</TT></li>
<li>print test page (described in
<a href="spec_testpage.html">spec_testpage.html</a>)</li>
<li>restore backed-up settings</li>
<li>restart lpd again</li>
</ul>
If no testpage is going to be printed, additional settings are saved:
<ul>
<li>newly autodetected printers are saved to <TT>.var.lib.yast.unique</TT></li>
<li>parallel ports settings are saved to <TT>/etc/modules.conf</TT></li>
<li>save default printer and start lpd to rc.config</li>
<li>run <TT>/bin/SuSEconfig</TT> to update profiles</li>
<li>restart lpd</li>
<li>remove backed up files</li>
</ul>
</P>
<H3>Parallel ports settings</H3>
<P>
By default, SuSE linux installs <TT>parport_pc io=0x378 irq=none,none</TT> into
<TT>/etc/modules.conf</TT>. Io ports can be changed in bios on some machines.
libhd can read these settings from bios and reload <TT>parport_pc</TT> module
with there settings. This happens when <TT>Read(.probe.byclass.comm.par)</TT> is
called. So printconf reads <TT>.probe.byclass.comm.par</TT> in the beggining to
have correct parport settings. When saving configuration, settings of parports
are saved to <TT>/etc/modules.conf</TT>. But there can be more parports that
that configured in bios. Hence if there are settings for more parports in
<TT>/etc/modules.conf</TT> then detected parports, additional parports settings
are not overwritten.
</P>
</BODY>
</HTML>
